# Ralph Progress Log

## Codebase Patterns
- `flowchart/` enforces `react-hooks/refs`: don’t read `ref.current` during render; compute initial state without refs and only use refs in callbacks/effects.
- Prefer Go stdlib (`net/http`, `flag`, `net.Listen`) for the console to avoid external module download flakiness during development/CI.
- Canonicalize the UI origin early: use `console.RedirectLocalhostTo127(...)` so browser requests land on `127.0.0.1` (helps strict Origin checks later).
- Protect all `POST /api/*` routes using `console.RequireWriteAuth(...)` (Origin allowlist + `X-Session-Token`), and inject the token into the UI via `<meta name="ohmyagentflow-session-token" ...>`.

Started: Thu Feb  5 19:53:13 CST 2026
---

## 2026-02-05 20:08:07 CST - US-001
- Implemented a minimal local console server that binds to `127.0.0.1` and supports `--port` (default random free port) and `--no-open`.
- Startup prints the canonical Base URL to stdout and attempts OS-specific auto-open (`open` on macOS, `xdg-open` on Linux) with warning-only failures.
- Files changed: `go.mod`, `cmd/ohmyagentflow/main.go`, `internal/console/listen.go`, `internal/console/listen_test.go`, `AGENTS.md`, `flowchart/src/App.tsx`
- **Learnings for future iterations:**
  - The repo’s `flowchart/` lint rules forbid reading refs during render; keep ref reads inside callbacks/effects only.
  - Network/proxy access for Go modules may be unreliable; prefer stdlib until the console codebase is stable enough to vendor or pin deps.
---

## 2026-02-05 20:19:31 CST - US-002
- Added a canonical-host middleware that 302-redirects `http://localhost:<port>` UI requests to `http://127.0.0.1:<port>`, preserving path + query.
- Wired the console HTTP server to use the middleware so all future UI assets/API routes benefit automatically.
- Files changed: `cmd/ohmyagentflow/main.go`, `internal/console/canonical_host.go`, `internal/console/canonical_host_test.go`, `prd.json`, `progress.txt`
- **Learnings for future iterations:**
  - Keep redirects limited to `GET`/`HEAD` so future `POST /api/*` semantics aren’t altered by a 302.
  - The PRD asks for browser verification via a dev-browser skill; this iteration validated redirect behavior via `curl` instead.
---

## 2026-02-05 20:26:51 CST - US-003
- Added a startup session token and a `POST /api/*` auth middleware that enforces strict Origin allowlisting plus `X-Session-Token`.
- Injected the session token into the root HTML via `<meta name="ohmyagentflow-session-token" ...>` and patched `window.fetch` to auto-attach `X-Session-Token` to all `POST /api/*` calls.
- Added a minimal `POST /api/ping` endpoint for smoke testing.
- Files changed: `cmd/ohmyagentflow/main.go`, `internal/console/write_auth.go`, `internal/console/write_auth_test.go`, `prd.json`, `progress.txt`
- **Learnings for future iterations:**
  - Browsers reliably send `Origin` on `fetch()` POSTs; requiring `Origin` + a per-run session token is a simple CSRF-style guard for local consoles.
  - Keep the auth middleware narrow (only `POST` + `/api/` prefix) so non-write UI routes remain unaffected.
---
