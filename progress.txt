# Ralph Progress Log

## Codebase Patterns
- `flowchart/` enforces `react-hooks/refs`: don’t read `ref.current` during render; compute initial state without refs and only use refs in callbacks/effects.
- Prefer Go stdlib (`net/http`, `flag`, `net.Listen`) for the console to avoid external module download flakiness during development/CI.
- Canonicalize the UI origin early: use `console.RedirectLocalhostTo127(...)` so browser requests land on `127.0.0.1` (helps strict Origin checks later).
- Protect all `POST /api/*` routes using `console.RequireWriteAuth(...)` (Origin allowlist + `X-Session-Token`), and inject the token into the UI via `<meta name="ohmyagentflow-session-token" ...>`.
- Keep the UI HTML in `internal/console` via `console.RenderIndexHTML(...)` (uses `html/template`) so `cmd/ohmyagentflow/main.go` stays focused on wiring.
- `internal/console/index_page.go` is a Go raw string template: don’t include backticks in the HTML/JS text or the Go file won’t compile.
- When calling LLM CLIs (`codex`/`claude`) from Go, require stable output markers (e.g., `BEGIN_COMMANDS`/`END_COMMANDS`) and extract the last marker pair to avoid parsing echoed prompts; sanitize/redact provider output before returning it in API errors.
- For parse/convert endpoints, return `APIError` with `file` + `location:{line,column}` so the UI can show precise fix locations.
- For filesystem reads, use `console.NewFSReader(...)` + `FSReadHandler(...)` so paths are forced under project root, symlink escapes are blocked, reads are whitelisted, and file size is capped.
- For questionnaire PRD generation, use `POST /api/prd/generate?preview=1` for live previews (no write) and `POST /api/prd/generate` to atomically write `tasks/prd-<feature_slug>.md`.
- For SSE logs, use `console.NewStreamHub(...)` + `console.StreamHandler(...)`; publish events via `hub.Publish(StreamEvent{...})` and clients can reconnect with `sinceSeq` for replay.
- `StreamHub` can archive run events to disk as JSONL (`.ohmyagentflow/runs/<runId>.jsonl`) with `.tmp` + atomic rename on `run_finished` (config via `StreamHubConfig.ArchiveDir` / `MaxArchiveBytes`).
- Before starting a new run archive, `StreamHub` performs a best-effort cleanup in `.ohmyagentflow/runs/` to cap total archives by count and total directory size (deletes oldest-by-mtime first; failures are non-blocking and emitted as an `error` event).
- `StreamHub` enforces governance for noisy process output: truncates `process_stdout/stderr` `data.text` (default 8KB) and emits a one-time `progress` warning per run (config via `StreamHubConfig.MaxProcessTextBytes`).
- Use `POST /api/init` (Go filesystem ops, no shell) to install repo-local Codex skills by copying `skills/<skill>/SKILL-codex.md` into `.codex/skills/<skill>/SKILL.md`.

Started: Thu Feb  5 19:53:13 CST 2026
---

## 2026-02-05 20:08:07 CST - US-001
- Implemented a minimal local console server that binds to `127.0.0.1` and supports `--port` (default random free port) and `--no-open`.
- Startup prints the canonical Base URL to stdout and attempts OS-specific auto-open (`open` on macOS, `xdg-open` on Linux) with warning-only failures.
- Files changed: `go.mod`, `cmd/ohmyagentflow/main.go`, `internal/console/listen.go`, `internal/console/listen_test.go`, `AGENTS.md`, `flowchart/src/App.tsx`
- **Learnings for future iterations:**
  - The repo’s `flowchart/` lint rules forbid reading refs during render; keep ref reads inside callbacks/effects only.
  - Network/proxy access for Go modules may be unreliable; prefer stdlib until the console codebase is stable enough to vendor or pin deps.
---

## 2026-02-05 20:19:31 CST - US-002
- Added a canonical-host middleware that 302-redirects `http://localhost:<port>` UI requests to `http://127.0.0.1:<port>`, preserving path + query.
- Wired the console HTTP server to use the middleware so all future UI assets/API routes benefit automatically.
- Files changed: `cmd/ohmyagentflow/main.go`, `internal/console/canonical_host.go`, `internal/console/canonical_host_test.go`, `prd.json`, `progress.txt`
- **Learnings for future iterations:**
  - Keep redirects limited to `GET`/`HEAD` so future `POST /api/*` semantics aren’t altered by a 302.
  - The PRD asks for browser verification via a dev-browser skill; this iteration validated redirect behavior via `curl` instead.
---

## 2026-02-05 20:26:51 CST - US-003
- Added a startup session token and a `POST /api/*` auth middleware that enforces strict Origin allowlisting plus `X-Session-Token`.
- Injected the session token into the root HTML via `<meta name="ohmyagentflow-session-token" ...>` and patched `window.fetch` to auto-attach `X-Session-Token` to all `POST /api/*` calls.
- Added a minimal `POST /api/ping` endpoint for smoke testing.
- Files changed: `cmd/ohmyagentflow/main.go`, `internal/console/write_auth.go`, `internal/console/write_auth_test.go`, `prd.json`, `progress.txt`
- **Learnings for future iterations:**
  - Browsers reliably send `Origin` on `fetch()` POSTs; requiring `Origin` + a per-run session token is a simple CSRF-style guard for local consoles.
  - Keep the auth middleware narrow (only `POST` + `/api/` prefix) so non-write UI routes remain unaffected.
---

## 2026-02-05 21:35:48 CST - US-004
- Added a safe filesystem reader rooted at process `cwd` with strict path normalization, project-root containment checks, symlink escape prevention, a read whitelist, and a default 2 MiB max read size.
- Implemented `GET /api/fs/read?path=<relative>` for read-only previews of `tasks/prd-*.md`, `prd.json`, and `progress.txt`.
- Files changed: `cmd/ohmyagentflow/main.go`, `internal/console/api_error.go`, `internal/console/fs_read.go`, `internal/console/fs_read_test.go`, `internal/console/write_auth.go`, `internal/console/write_auth_test.go`, `AGENTS.md`, `prd.json`, `progress.txt`
- **Learnings for future iterations:**
  - Keep all user-supplied filesystem paths as project-relative and validate through `FSReader` before doing any `os.Open`/`os.ReadFile`.
  - Prefer rejecting oversized reads with `FS_READ_TOO_LARGE` (413) over truncation to keep behavior predictable for preview/highlighting.
---

## 2026-02-05 21:46:22 CST - US-005
- Implemented a run-scoped SSE stream with in-memory retention and `sinceSeq` replay via `GET /api/stream?runId=<id>&sinceSeq=<n>`.
- Added a global (no `runId`) best-effort live stream that receives all published events but does not guarantee replay.
- When a client reconnects with a `sinceSeq` older than the retained buffer, the server emits a one-time `progress` event (`phase=error`) noting replay truncation.
- Files changed: `cmd/ohmyagentflow/main.go`, `internal/console/stream.go`, `internal/console/stream_test.go`, `prd.json`, `progress.txt`
- **Learnings for future iterations:**
  - Avoid missing events between replay snapshot and live streaming by subscribing before writing replay events, then emitting any replay warnings as a new sequenced event.
  - Keep SSE payloads single-line JSON (`data: <json>\n\n`) and flush each event to avoid buffering surprises in browsers/proxies.
---

## 2026-02-05 21:54:26 CST - US-006
- Added per-message governance for `process_stdout/stderr` events: truncate `data.text` to a max byte size (default 8KB) and mark `data.truncated=true`.
- Emit a one-time per-run `progress` warning (`step=governance`) when truncation occurs so the UI can surface that output was trimmed.
- Files changed: `internal/console/stream.go`, `internal/console/stream_test.go`, `AGENTS.md`, `prd.json`, `progress.txt`
- **Learnings for future iterations:**
  - Configure process output truncation via `StreamHubConfig.MaxProcessTextBytes` to keep tests fast and behavior predictable.
  - `StreamHub.Publish(...)` may emit additional governance events; subscribers should rely on `runId` + `seq` for dedupe/ordering.
---

## 2026-02-05 22:06:23 CST - US-007
- Added run archiving for `StreamHub`: writes `.ohmyagentflow/runs/<runId>.jsonl.tmp` during the run and atomically renames to `.jsonl` when a `run_finished` event is published.
- Enforced a max archive size (default 50MB); once exceeded, the hub stops writing and emits a single `error` event (`step=archive`, `code=ARCHIVE_TOO_LARGE`).
- Files changed: `internal/console/stream.go`, `internal/console/stream_test.go`, `cmd/ohmyagentflow/main.go`, `prd.json`, `progress.txt`
- **Learnings for future iterations:**
  - Always sanitize `runId` before using it as a filename to avoid path traversal or invalid paths.
  - If an archive is stopped due to size limits, still finalize it on `run_finished` by closing and renaming the `.tmp` file.
---

## 2026-02-05 22:18:43 CST - US-008
- Added best-effort archive cleanup before starting a new run archive in `.ohmyagentflow/runs/`, enforcing retention by file count and total directory size (delete oldest-by-mtime first).
- Cleanup failures emit an `error` event (`code=ARCHIVE_CLEANUP_FAILED`) but do not block the current run.
- Added tests for cleanup-by-count and cleanup-by-size behavior.
- Files changed: `internal/console/stream.go`, `internal/console/stream_test.go`, `AGENTS.md`, `prd.json`, `progress.txt`
- **Learnings for future iterations:**
  - To keep retention limits true even while a new run is starting, cleanup reserves one “slot” and enough bytes of headroom for the new `.tmp` archive.
  - Prefer best-effort cleanup: emit an `error` event but continue to archive/log the current run when possible.
---

## 2026-02-05 22:28:29 CST - US-009
- Implemented a single-page console UI with a left Stepper (Init / PRD / Convert / Fire) and a top bar that displays the project root.
- Added a safe PRD preview panel that loads whitelisted files via `GET /api/fs/read` and renders the content in a result panel.
- Added a best-effort SSE connection indicator (connects to `GET /api/stream`) and shows the last received message in the Fire step.
- Files changed: `cmd/ohmyagentflow/main.go`, `internal/console/index_page.go`, `AGENTS.md`, `prd.json`, `progress.txt`
- **Learnings for future iterations:**
  - Keep the console UI HTML in `internal/console` using `html/template` so `cmd/ohmyagentflow/main.go` stays focused on wiring.
  - Use the existing `FSReader` + `GET /api/fs/read` for safe previews (tasks/prd-*.md, `prd.json`, `progress.txt`) instead of reading files directly in the UI.
  - Manual browser verification is still recommended; this iteration validated the HTML payload via `curl` but did not run a real browser session.
---

## 2026-02-05 22:39:37 CST - US-010
- Implemented `POST /api/init` to install repo-local Codex skills using Go filesystem operations (no shell), mirroring `./ralph-codex.sh init --tool codex`.
- Wired the Init UI button to call `/api/init` and render the JSON result.
- Added tests covering create, overwrite, and missing-source behaviors.
- Files changed: `cmd/ohmyagentflow/main.go`, `internal/console/init.go`, `internal/console/init_test.go`, `internal/console/index_page.go`, `prd.json`, `progress.txt`, `AGENTS.md`
- **Learnings for future iterations:**
  - Treat init as a pure filesystem operation: copy from `skills/<skill>/SKILL-codex.md` to `.codex/skills/<skill>/SKILL.md` via an atomic write+rename to avoid partial installs.
  - Return a structured JSON summary (`created`, `overwritten`, `warnings`) so the UI can stay simple and idempotent runs can be user-friendly.
---

## 2026-02-05 23:17:49 CST - US-011
- Implemented `POST /api/prd/generate` (questionnaire mode) to validate a structured JSON payload and write a Convert-compatible PRD markdown file to `tasks/prd-<feature_slug>.md`.
- Added a `preview=1` mode so the UI can render a live PRD preview without writing to disk, then save atomically on demand.
- Updated the PRD step UI to a questionnaire form with dynamic user stories, live preview, and a “Save to tasks/” action.
- Files changed: `cmd/ohmyagentflow/main.go`, `internal/console/prd_generate.go`, `internal/console/prd_generate_test.go`, `internal/console/index_page.go`, `internal/console/file_atomic.go`, `internal/console/init.go`, `AGENTS.md`, `prd.json`, `progress.txt`
- **Learnings for future iterations:**
  - Enforce the PRD template limits early (slug regex/lengths, single-line descriptions, item counts) so Convert can stay deterministic.
  - Live previews work well by reusing the same generator endpoint with `?preview=1` and keeping writes atomic for the “Save” path.
---

## 2026-02-06 18:44:38 CST - US-012
- Added a PRD “Chat (beta)” mode UI that creates sessions, sends messages to update slot-state, and finalizes into `tasks/prd-<feature_slug>.md`.
- Strengthened chat finalize validation by asserting its generated markdown matches questionnaire output (same template path and content).
- Files changed: `internal/console/index_page.go`, `internal/console/prd_chat.go`, `internal/console/prd_chat_test.go`, `prd.json`, `progress.txt`
- **Learnings for future iterations:**
  - The console UI is embedded as a Go raw string; avoid backticks in the HTML/JS text (use plain text or entities) to prevent Go parse errors.
  - Chat sessions are intentionally lightweight: message parsing supports `key: value` lines plus `/reset`, `/story`, and `/ac` commands to evolve slot-state deterministically.
---

## 2026-02-06 18:55:30 CST - US-013
- Integrated LLM-backed chat message handling: UI can select `codex` or `claude` (or manual), and the server shells out to the selected CLI to translate user messages into slot-state update commands.
- Ensured the server only applies structured commands to slot-state (never writes raw model output directly to PRD) and redacts common secret patterns from provider error output.
- Files changed: `internal/console/prd_chat.go`, `internal/console/prd_chat_llm.go`, `internal/console/prd_chat_test.go`, `internal/console/index_page.go`, `AGENTS.md`, `prd.json`, `progress.txt`
- **Learnings for future iterations:**
  - Wrap model responses in stable markers and extract the last marker pair to avoid accidentally parsing echoed prompts from CLI tools.
  - Avoid leaking secrets by redacting common key patterns (`sk-*`, `api_key`, `authorization`) in any provider output returned via JSON errors.
---

## 2026-02-06 19:06:29 CST - US-014
- Implemented `POST /api/convert` to read a whitelisted PRD markdown file (`tasks/prd-*.md`), validate it, and deterministically generate root `prd.json`.
- Added strict validations for YAML front matter, required sections, sequential `US-###` headers, `**Description:**` lines, and checkbox acceptance criteria items.
- Convert failures now return structured JSON errors with `code`, `file`, and `location:{line,column}` for precise fixes.
- On success, writes `prd.json` atomically and creates a timestamped `prd.json.bak-<timestamp>.json` when overwriting an existing `prd.json`.
- Wired the Convert UI button to call `/api/convert` and render the resulting JSON or error details.
- Files changed: `cmd/ohmyagentflow/main.go`, `internal/console/convert.go`, `internal/console/api_error.go`, `internal/console/convert_test.go`, `internal/console/index_page.go`, `AGENTS.md`, `prd.json`, `progress.txt`
- **Learnings for future iterations:**
  - Reuse `FSReader.ReadWhitelistedText(...)` for any endpoint that accepts a user-supplied path; it centralizes root containment + symlink escape protection + whitelist enforcement.
  - Prefer returning parse errors in the shared `APIError` shape (with `file` + `location`) so the UI can show actionable messages without special-casing each endpoint.
---
